<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BloxWorks</title>
  <style>
    :root {
      --bg: #f4f4f4; --text: #222; --card: #fff; --primary: #28a745; --header:#fff; --header-text:#222;
    }
    body.dark {
      --bg:#1e1e1e; --text:#ddd; --card:#2b2b2b; --primary:#ff8800; --header:#2b2b2b; --header-text:#fff;
    }
    body { margin:0; font-family:Arial,sans-serif; background:var(--bg); color:var(--text);}
    header { background:var(--header); color:var(--header-text); padding:10px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ccc;}
    .logo{font-size:22px;font-weight:bold;}
    nav{display:flex;justify-content:center;margin:10px;flex-wrap:wrap;}
    nav button{margin:5px;padding:8px 14px;border:none;cursor:pointer;border-radius:5px;background:var(--primary);color:white;}
    #content{padding:20px;max-width:1000px;margin:auto;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px;}
    .card{background:var(--card);padding:15px;border-radius:6px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    input,textarea,select{width:100%;padding:8px;margin:5px 0;border-radius:4px;border:1px solid #ccc;background:var(--card);color:var(--text);}
    button.action{background:var(--primary);color:white;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;}
    #chatBox{border:1px solid #ccc;height:250px;overflow-y:scroll;padding:10px;background:var(--card);}
    .msg{margin:5px 0;}
    .hidden{display:none;}
    .pinned{border:2px solid gold;}
  </style>
</head>
<body>
  <header>
    <div class="logo">üß± BloxWorks</div>
    <div id="auth"></div>
    <button onclick="toggleTheme()">üåì</button>
  </header>

  <nav id="nav" class="hidden">
    <button onclick="showTab('browse')">Browse</button>
    <button onclick="showTab('create')">Create Post</button>
    <button onclick="showTab('myposts')">My Posts</button>
    <button onclick="showTab('chats')">Chats</button>
    <button onclick="showTab('notifications')">Notifications</button>
    <button onclick="showTab('report')">Report</button>
    <button onclick="showTab('settings')">Settings</button>
    <button id="adminBtn" class="hidden" onclick="showTab('admin')">Admin Dashboard</button>
    <button onclick="logout()">Logout</button>
  </nav>

  <div id="content"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let me=null; 
    let socket=null; 
    let privateChatUser=null;
    let pinnedChats = JSON.parse(localStorage.getItem("pinnedChats")||"[]");

    function toggleTheme(){document.body.classList.toggle("dark");}

    // ==== AUTH ====
    function showAuth(){
      const div=document.getElementById("auth");
      const nav=document.getElementById("nav");
      if(!me){
        nav.classList.add("hidden");
        div.innerHTML=`<input id="username" placeholder="Username">
        <input id="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <div style="border:1px solid #ccc; padding:8px; max-height:100px; overflow-y:auto; font-size:12px; margin:8px 0; background:#fdfdfd;">
          <b>BloxWorks Terms of Service</b><br>
          ‚Ä¢ You are 13+.<br>
          ‚Ä¢ No scams, spam, harassment or illegal activity.<br>
          ‚Ä¢ Payments are between users, BloxWorks is not liable.<br>
          ‚Ä¢ Reports may result in suspension/ban.<br>
        </div>
        <label><input type="checkbox" id="tosCheck"> I agree to the Terms of Service</label><br>
        <button onclick="signup()">Sign Up</button>
        <button onclick="login()">Login</button>`;
        document.getElementById("content").innerHTML="";
      } else {
        nav.classList.remove("hidden");
        if(me.is_admin) document.getElementById("adminBtn").classList.remove("hidden");
        else document.getElementById("adminBtn").classList.add("hidden");
        div.innerHTML=`üë§ ${me.username}`;
        showTab("browse");
      }
    }

    async function signup(){
      if(!document.getElementById("tosCheck").checked) return alert("You must agree to the Terms of Service");
      const username=document.getElementById("username").value.trim();
      const email=document.getElementById("email").value.trim();
      const password=document.getElementById("password").value.trim();
      if(!username||!email||!password) return alert("All fields required");
      const res=await fetch("/api/signup",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username,email,password}),
        credentials:"include"
      });
      if(res.ok){ me=await res.json(); showAuth(); } else { const e=await res.json(); alert(e.error); }
    }

    async function login(){
      const username=document.getElementById("username").value.trim();
      const password=document.getElementById("password").value.trim();
      if(!username||!password) return alert("Enter username & password");
      const res=await fetch("/api/login",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username,password}),
        credentials:"include"
      });
      if(res.ok){ me=await res.json(); showAuth(); } else { const e=await res.json(); alert(e.error); }
    }

    function logout(){ me=null; document.cookie="token=; Max-Age=0"; showAuth(); }

    // ==== NAV ====
    function showTab(tab){
      const c=document.getElementById("content");
      if(tab==="browse") renderBrowse(c);
      if(tab==="create") renderCreate(c);
      if(tab==="myposts") renderMyPosts(c);
      if(tab==="chats") renderChats(c);
      if(tab==="notifications") renderNotifications(c);
      if(tab==="report") renderReport(c);
      if(tab==="settings") renderSettings(c);
      if(tab==="admin") renderAdmin(c);
    }

    // ==== BROWSE ====
    async function renderBrowse(c){
      c.innerHTML=`<h2>Browse Posts</h2>
      <select id="filter" onchange="loadPosts()"><option value="all">All</option><option value="hiring">Hiring</option><option value="for_hire">For Hire</option></select>
      <input id="userFilter" placeholder="Filter by username" oninput="loadPosts()">
      <div class="grid" id="postList"></div>`;
      loadPosts();
    }
    async function loadPosts(){
      const res=await fetch("/api/posts",{credentials:"include"});
      const posts=await res.json();
      const list=document.getElementById("postList"); list.innerHTML="";
      const filter=document.getElementById("filter")?.value||"all";
      const uf=document.getElementById("userFilter")?.value||"";
      if(!Array.isArray(posts)) { list.innerHTML="<p>Error loading posts.</p>"; return; }
      posts.filter(p=>(filter==="all"||p.mode===filter)&&(uf===""||p.username.includes(uf))).forEach(p=>{
        let timeLeft = "";
        const now = Date.now();
        const expiry = 72*60*60*1000;
        const remain = expiry - (now - p.created_at);
        if(remain>0){
          const h=Math.floor(remain/3600000); const d=Math.floor(h/24);
          timeLeft = `Expires in ${d}d ${h%24}h`;
        } else timeLeft="Expired";
        list.innerHTML+=`<div class="card">
          <h3>${p.title}</h3>
          <p>${p.description}</p>
          <p><b>Budget:</b> ${p.budget} | <b>Payment:</b> ${p.payment} | <b>Timeline:</b> ${p.timeline} | <b>Category:</b> ${p.category}</p>
          <i>${p.mode} by ${p.username}</i><br>
          <small>${timeLeft}</small><br>
          <button onclick="openPrivateChat('${p.username}')">üí¨ Chat</button>
          ${me.is_admin?`<button onclick="adminDeletePost(${p.id})">üóë Delete</button><button onclick="adminSuspendPost(${p.id})">‚è∏ Suspend</button>`:""}
        </div>`;
      });
    }

    // ==== CREATE POST ====
    function renderCreate(c){
      c.innerHTML=`<h2>Create Post</h2>
      <div class="card">
        <select id="mode"><option value="hiring">Hiring</option><option value="for_hire">For Hire</option></select>
        <input id="title" placeholder="Title">
        <textarea id="desc" placeholder="Description"></textarea>
        <input id="budget" placeholder="Budget">
        <select id="payment"><option>Robux</option><option>PayPal</option><option>Crypto</option><option>Other</option></select>
        <input id="timeline" placeholder="Timeline (e.g. 2 weeks)">
        <input id="category" placeholder="Category">
        <button class="action" onclick="createPost()">Create</button>
      </div>`;
    }
    async function createPost(){
      const body={mode:document.getElementById("mode").value,title:document.getElementById("title").value,
        description:document.getElementById("desc").value,budget:document.getElementById("budget").value,
        payment:document.getElementById("payment").value,timeline:document.getElementById("timeline").value,
        category:document.getElementById("category").value};
      const res=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),credentials:"include"});
      if(res.ok){ alert("Post created!"); showTab("myposts"); } else { const e=await res.json(); alert(e.error); }
    }

    // ==== MY POSTS ====
    async function renderMyPosts(c){
      const res=await fetch("/api/posts",{credentials:"include"}); const posts=await res.json();
      const mine=Array.isArray(posts)?posts.find(p=>p.username===me.username):null;
      if(!mine){ c.innerHTML="<p>You have no post. Create one!</p>"; return; }
      c.innerHTML=`<h2>My Post</h2>
        <div class="card">
          <input id="mtitle" value="${mine.title}">
          <textarea id="mdesc">${mine.description}</textarea>
          <input id="mbudget" value="${mine.budget}">
          <input id="mpayment" value="${mine.payment}">
          <input id="mtimeline" value="${mine.timeline}">
          <input id="mcategory" value="${mine.category}">
          <button onclick="editPost(${mine.id})">Save</button>
          <button onclick="deletePost(${mine.id})">Delete</button>
        </div>`;
    }
    async function editPost(id){
      const body={id,title:document.getElementById("mtitle").value,
        description:document.getElementById("mdesc").value,
        budget:document.getElementById("mbudget").value,
        payment:document.getElementById("mpayment").value,
        timeline:document.getElementById("mtimeline").value,
        category:document.getElementById("mcategory").value};
      await fetch("/api/editPost",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),credentials:"include"});
      alert("Updated!"); showTab("myposts");
    }
    async function deletePost(id){
      await fetch("/api/deletePost",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id}),credentials:"include"});
      alert("Deleted!"); showTab("browse");
    }

    // ==== CHATS ====
    async function renderChats(c){
      if(!privateChatUser){c.innerHTML="<h2>Chats</h2><p>Open a chat from a post.</p>"; return;}
      const pinnedClass=pinnedChats.includes(privateChatUser)?"pinned":"";
      c.innerHTML=`<h2>Chat with ${privateChatUser} <button onclick="pinChat('${privateChatUser}')">üìå</button></h2>
        <div id="chatBox" class="${pinnedClass}"></div>
        <input id="chatInput" placeholder="Message">
        <button onclick="sendMsg()">Send</button>`;
      if(!socket){socket=io(); socket.on("message",msg=>{
        if((msg.to===privateChatUser&&msg.user===me.username)||(msg.user===privateChatUser&&msg.to===me.username)){
          const box=document.getElementById("chatBox");
          box.innerHTML+=`<div class="msg"><b>${msg.user}:</b> ${msg.text}</div>`; box.scrollTop=box.scrollHeight;
        }
      });}
      loadMessages();
    }
    function openPrivateChat(user){ privateChatUser=user; showTab("chats"); }
    async function sendMsg(){
      const text=document.getElementById("chatInput").value;
      socket.emit("message",{user:me.username,text,to:privateChatUser}); document.getElementById("chatInput").value="";
    }
    async function loadMessages(){
      const res=await fetch(`/api/messages/${me.username}/${privateChatUser}`,{credentials:"include"});
      const msgs=await res.json(); const box=document.getElementById("chatBox"); box.innerHTML="";
      msgs.forEach(m=>{ box.innerHTML+=`<div class="msg"><b>${m.from_user}:</b> ${m.text}</div>`; });
    }
    function pinChat(user){
      if(pinnedChats.includes(user)){ pinnedChats=pinnedChats.filter(u=>u!==user); }
      else pinnedChats.push(user);
      localStorage.setItem("pinnedChats",JSON.stringify(pinnedChats));
      alert("Pinned chats updated!");
    }

    // ==== NOTIFICATIONS ====
    async function renderNotifications(c){
      c.innerHTML="<h2>Notifications</h2>";
      if(pinnedChats.length===0){ c.innerHTML+="<p>No new chats.</p>"; return; }
      pinnedChats.forEach(u=>{
        c.innerHTML+=`<div class="card"><b>${u}</b> started a chat. <button onclick="openPrivateChat('${u}')">Open</button></div>`;
      });
    }

    // ==== REPORT ====
    function renderReport(c){
      c.innerHTML=`<h2>Report Scammer</h2>
      <div class="card">
        <input id="accused" placeholder="Scammer Username">
        <input id="reporterEmail" type="email" placeholder="Your Email">
        <textarea id="reason" placeholder="Reason"></textarea>
        <button class="action" onclick="sendReport()">Submit</button>
        <div id="reportMsg"></div>
      </div>`;
    }
    async function sendReport(){
      const accused=document.getElementById("accused").value;
      const reason=document.getElementById("reason").value;
      const reporter=document.getElementById("reporterEmail").value;
      const res=await fetch("/api/report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accused,reason,reporter}),credentials:"include"});
      document.getElementById("reportMsg").innerText=res.ok?"‚úÖ Report Sent":"‚ùå Failed";
    }

    // ==== SETTINGS ====
    function renderSettings(c){
      c.innerHTML=`<h2>Settings</h2>
        <button onclick="deleteAccount()">Delete My Account</button>`;
    }
    async function deleteAccount(){
      if(confirm("Are you sure you want to delete your account? This cannot be undone.")){
        await fetch("/api/deleteAccount",{method:"POST",credentials:"include"});
        alert("Account deleted."); logout();
      }
    }

    // ==== ADMIN ====
    async function renderAdmin(c){
      c.innerHTML="<h2>Admin Dashboard</h2>";
      const users=await (await fetch("/api/admin/users",{credentials:"include"})).json();
      const posts=await (await fetch("/api/admin/posts",{credentials:"include"})).json();
      c.innerHTML+=`<h3>Users</h3><div class="grid">`+users.map(u=>`
        <div class="card">
          <b>${u.username}</b> (${u.email}) ${u.banned?"[BANNED]":""}
          <br><button onclick="banUser('${u.username}')">üö´ Ban</button>
          <button onclick="deleteUser('${u.username}')">üóë Delete</button>
        </div>`).join("")+"</div>";
      c.innerHTML+=`<h3>Posts</h3><div class="grid">`+posts.map(p=>`
        <div class="card">
          <b>${p.title}</b> by ${p.username}
          <br>${p.description}
          <br><button onclick="adminDeletePost(${p.id})">üóë Delete</button>
          <button onclick="adminSuspendPost(${p.id})">‚è∏ Suspend</button>
        </div>`).join("")+"</div>";
    }
    async function adminDeletePost(id){await fetch("/api/deletePostAdmin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id}),credentials:"include"});alert("Deleted");showTab("admin");}
    async function adminSuspendPost(id){await fetch("/api/suspendPost",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id}),credentials:"include"});alert("Suspended");showTab("admin");}
    async function banUser(u){await fetch("/api/banUser",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u}),credentials:"include"});alert("Banned");showTab("admin");}
    async function deleteUser(u){await fetch("/api/deleteUser",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u}),credentials:"include"});alert("Deleted");showTab("admin");}

    showAuth();
  </script>
</body>
</html>
<script>
  // ... everything as before ...

  async function checkAuth() {
    const res = await fetch("/api/loginStatus",{credentials:"include"});
    if(res.ok){
      me = await res.json();
      showAuth();
    } else {
      showAuth();
    }
  }

  checkAuth(); // <--- replaces showAuth();
</script>
