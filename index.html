<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BloxWorks</title>
  <style>
    :root {
      --bg: #e6f2ff; 
      --text: #222; 
      --card: #ffffff; 
      --primary: #007bff; 
      --header:#004080; 
      --header-text:#fff;
      --card-border:#cce0ff;
    }
    body.dark {
      --bg:#1e1e1e; 
      --text:#ddd; 
      --card:#2b2b2b; 
      --primary:#ff8800; 
      --header:#2b2b2b; 
      --header-text:#fff;
      --card-border:#444;
    }
    body { 
      margin:0; 
      font-family:Arial,sans-serif; 
      background:var(--bg); 
      color:var(--text);
    }
    header { 
      background:var(--header); 
      color:var(--header-text); 
      padding:10px 20px; 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    .logo{font-size:22px;font-weight:bold;}
    nav{
      display:flex;
      justify-content:center;
      margin:10px;
      flex-wrap:wrap;
    }
    nav button{
      margin:5px;
      padding:10px 16px;
      border:none;
      cursor:pointer;
      border-radius:6px;
      background:var(--primary);
      color:white;
      position:relative;
      transition:0.2s;
    }
    nav button:hover{opacity:0.85;}
    #notifBadge{
      position:absolute;
      top:0;
      right:0;
      background:red;
      color:white;
      font-size:12px;
      padding:2px 6px;
      border-radius:50%;
      display:none;
    }
    #content{padding:20px;max-width:1000px;margin:auto;}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
      gap:20px;
    }
    .card{
      background:var(--card);
      padding:18px;
      border-radius:10px;
      border:2px solid var(--card-border);
      box-shadow:0 4px 8px rgba(0,0,0,0.15);
      transition:0.2s;
      min-height:180px;
    }
    .card:hover{transform:translateY(-3px);}
    input,textarea,select{
      width:100%;
      padding:8px;
      margin:5px 0;
      border-radius:4px;
      border:1px solid #ccc;
      background:var(--card);
      color:var(--text);
    }
    button.action{
      background:var(--primary);
      color:white;
      border:none;
      padding:8px 12px;
      border-radius:4px;
      cursor:pointer;
    }
    #chatBox{
      border:1px solid #ccc;
      height:250px;
      overflow-y:scroll;
      padding:10px;
      background:var(--card);
    }
    .msg{margin:5px 0;}
    .hidden{display:none;}
    .pinned{border:2px solid gold;}
    .tos-box {
      max-height:150px;
      overflow-y:auto;
      padding:10px;
      margin:10px 0;
      border:1px solid #ccc;
      background:#f9f9f9;
      font-size:13px;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">🧱 BloxWorks</div>
    <div id="auth"></div>
    <button onclick="toggleTheme()">🌓</button>
  </header>

  <nav id="nav" class="hidden">
    <button onclick="showTab('browse')">Browse</button>
    <button onclick="showTab('create')">Create Post</button>
    <button onclick="showTab('myposts')">My Posts</button>
    <button onclick="showTab('chats')">Chats</button>
    <button onclick="showTab('notifications')">Notifications <span id="notifBadge">0</span></button>
    <button onclick="showTab('report')">Report</button>
    <button onclick="showTab('plans')">Plans</button>
    <button onclick="showTab('settings')">Settings</button>
    <button id="adminBtn" class="hidden" onclick="showTab('admin')">Admin Dashboard</button>
    <button onclick="logout()">Logout</button>
  </nav>

  <div id="content"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://www.paypal.com/sdk/js?client-id=AdPtlE6hfWgvZjnxgKA6DAZRqRh8sZp32MNKOSbWysNAfBYYT5YL0dhDWDwAS5KjPayN4jvc7BCQc1ab&vault=true&intent=subscription"></script>
  <script>
    let me=null; 
    let socket=null; 
    let privateChatUser=null;
    let pinnedChats = JSON.parse(localStorage.getItem("pinnedChats")||"[]");
    let notifications = JSON.parse(localStorage.getItem("notifications")||"[]");

    function toggleTheme(){document.body.classList.toggle("dark");}

    // ==== SOCKET INIT ====
    function initSocket(){
      if(socket) return;
      socket = io();
      socket.on("message",msg=>{
        if((msg.to===privateChatUser&&msg.user===me.username)||(msg.user===privateChatUser&&msg.to===me.username)){
          const box=document.getElementById("chatBox");
          if(box){
            box.innerHTML+=`<div class="msg"><b>${msg.user}:</b> ${msg.text}</div>`;
            box.scrollTop=box.scrollHeight;
          }
        }
        if(msg.to===me.username && msg.user!==privateChatUser){
          addNotification({from:msg.user,text:msg.text,time:Date.now()});
        }
      });
      socket.on("notification",note=>{
        addNotification(note);
      });
    }

    // ==== NOTIFICATIONS ====
    function addNotification(note){
      notifications.push(note);
      localStorage.setItem("notifications", JSON.stringify(notifications));
      updateNotifBadge();
      if(document.getElementById("content").dataset.tab==="notifications"){
        renderNotifications(document.getElementById("content"));
      }
    }
    function updateNotifBadge(){
      const badge=document.getElementById("notifBadge");
      if(notifications.length>0){
        badge.style.display="inline-block";
        badge.textContent=notifications.length;
      } else {
        badge.style.display="none";
      }
    }

    // ==== AUTH ====
    function showAuth(){
      const div=document.getElementById("auth");
      const nav=document.getElementById("nav");
      if(!me){
        nav.classList.add("hidden");
        div.innerHTML=`<input id="username" placeholder="Username">
        <input id="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <div class="tos-box">
          <h4>Terms of Service</h4>
          <p>By using BloxWorks you agree that this platform is provided "as is" without warranties. 
          We are not liable for damages, losses, scams, or disputes between users. 
          Users are solely responsible for their interactions and agreements. 
          All payments, hires, and collaborations are at your own risk. 
          BloxWorks disclaims liability to the fullest extent permitted by law.</p>
        </div>
        <label><input type="checkbox" id="tosCheck"> I agree to Terms of Service</label><br>
        <button onclick="signup()">Sign Up</button>
        <button onclick="login()">Login</button>`;
        document.getElementById("content").innerHTML="";
      } else {
        nav.classList.remove("hidden");
        if(me.is_admin) document.getElementById("adminBtn").classList.remove("hidden");
        else document.getElementById("adminBtn").classList.add("hidden");
        div.innerHTML=`👤 ${me.username}`;
        showTab("browse");
      }
    }

    async function signup(){
      if(!document.getElementById("tosCheck").checked) return alert("You must agree to Terms of Service");
      const username=document.getElementById("username").value.trim();
      const email=document.getElementById("email").value.trim();
      const password=document.getElementById("password").value.trim();
      if(!username||!email||!password) return alert("All fields required");
      const res=await fetch("/api/signup",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username,email,password}),
        credentials:"include"
      });
      if(res.ok){ 
        alert("Signup successful! A 6-digit code has been sent to your email.");
        renderVerify(email);
      } else { const e=await res.json(); alert(e.error); }
    }

    function renderVerify(email){
      document.getElementById("content").innerHTML=`
        <h2>Verify Email</h2>
        <input id="vcode" placeholder="Enter 6-digit code">
        <button onclick="verifyCode('${email}')">Verify</button>`;
    }

    async function verifyCode(email){
      const code=document.getElementById("vcode").value.trim();
      const res=await fetch("/api/verifyCode",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({email,code}),
        credentials:"include"
      });
      if(res.ok){ alert("Email verified! You can now log in."); showAuth(); }
      else { const e=await res.json(); alert(e.error); }
    }

    async function login(){
      const username=document.getElementById("username").value.trim();
      const password=document.getElementById("password").value.trim();
      if(!username||!password) return alert("Enter username & password");
      const res=await fetch("/api/login",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username,password}),
        credentials:"include"
      });
      if(res.ok){ 
        me=await res.json(); 
        initSocket();
        socket.emit("join", me.username);
        showAuth(); 
      } else { const e=await res.json(); alert(e.error); }
    }

    function logout(){ me=null; document.cookie="token=; Max-Age=0"; showAuth(); }

    // ==== NAV HANDLER ====
    function showTab(tab){
      const c=document.getElementById("content");
      c.dataset.tab=tab;
      if(tab==="browse") renderBrowse(c);
      if(tab==="create") renderCreate(c);
      if(tab==="myposts") renderMyPosts(c);
      if(tab==="chats") renderChats(c);
      if(tab==="notifications") renderNotifications(c);
      if(tab==="report") renderReport(c);
      if(tab==="plans") renderPlans(c);
      if(tab==="settings") renderSettings(c);
      if(tab==="admin") renderAdmin(c);
    }

    // ==== BROWSE ====
    async function renderBrowse(c){
      c.innerHTML=`<h2>Browse Posts</h2>
      <select id="filter" onchange="loadPosts()"><option value="all">All</option><option value="hiring">Hiring</option><option value="for_hire">For Hire</option></select>
      <input id="userFilter" placeholder="Filter by username" oninput="loadPosts()">
      <div class="grid" id="postList"></div>`;
      loadPosts();
    }
    async function loadPosts(){
      const res=await fetch("/api/posts",{credentials:"include"});
      const posts=await res.json();
      const list=document.getElementById("postList"); list.innerHTML="";
      const filter=document.getElementById("filter")?.value||"all";
      const uf=document.getElementById("userFilter")?.value||"";
      if(!Array.isArray(posts)) { list.innerHTML="<p>Error loading posts.</p>"; return; }
      posts.filter(p=>(filter==="all"||p.mode===filter)&&(uf===""||p.username.includes(uf))).forEach(p=>{
        list.innerHTML+=`<div class="card">
          <h3>${p.title}</h3>
          <p>${p.description}</p>
          <p><b>Budget:</b> ${p.budget} | <b>Payment:</b> ${p.payment} | <b>Timeline:</b> ${p.timeline} | <b>Category:</b> ${p.category}</p>
          <i>${p.mode} by ${p.username}</i><br>
          <button onclick="openPrivateChat('${p.username}')">💬 Chat</button>
          ${me.is_admin?`<button onclick="adminDeletePost(${p.id})">🗑 Delete</button><button onclick="adminSuspendPost(${p.id})">⏸ Suspend</button>`:""}
        </div>`;
      });
    }

    // ==== CREATE POST ====
    function renderCreate(c){
      c.innerHTML=`<h2>Create Post</h2>
      <div class="card">
        <select id="mode"><option value="hiring">Hiring</option><option value="for_hire">For Hire</option></select>
        <input id="title" placeholder="Title">
        <textarea id="desc" placeholder="Description"></textarea>
        <input id="budget" placeholder="Budget">
        <select id="payment"><option>Robux</option><option>PayPal</option><option>Crypto</option><option>Other</option></select>
        <input id="timeline" placeholder="Timeline (e.g. 2 weeks)">
        <input id="category" placeholder="Category">
        <button class="action" onclick="createPost()">Create</button>
      </div>`;
    }
    async function createPost(){
      const body={mode:document.getElementById("mode").value,title:document.getElementById("title").value,
        description:document.getElementById("desc").value,budget:document.getElementById("budget").value,
        payment:document.getElementById("payment").value,timeline:document.getElementById("timeline").value,
        category:document.getElementById("category").value};
      const res=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),credentials:"include"});
      if(res.ok){ alert("Post created!"); showTab("myposts"); } else { const e=await res.json(); alert(e.error); }
    }

    // ==== MY POSTS ====
    async function renderMyPosts(c){
      const res=await fetch("/api/posts",{credentials:"include"}); const posts=await res.json();
      const mine=Array.isArray(posts)?posts.find(p=>p.username===me.username):null;
      if(!mine){ c.innerHTML="<p>You have no post. Create one!</p>"; return; }
      c.innerHTML=`<h2>My Post</h2>
        <div class="card">
          <input id="mtitle" value="${mine.title}">
          <textarea id="mdesc">${mine.description}</textarea>
          <input id="mbudget" value="${mine.budget}">
          <input id="mpayment" value="${mine.payment}">
          <input id="mtimeline" value="${mine.timeline}">
          <input id="mcategory" value="${mine.category}">
          <button onclick="editPost(${mine.id})">Save</button>
          <button onclick="deletePost(${mine.id})">Delete</button>
        </div>`;
    }
    async function editPost(id){
      const body={id,title:document.getElementById("mtitle").value,
        description:document.getElementById("mdesc").value,
        budget:document.getElementById("mbudget").value,
        payment:document.getElementById("mpayment").value,
        timeline:document.getElementById("mtimeline").value,
        category:document.getElementById("mcategory").value};
      await fetch("/api/editPost",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),credentials:"include"});
      alert("Updated!"); showTab("myposts");
    }
    async function deletePost(id){
      await fetch("/api/deletePost",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id}),credentials:"include"});alert("Deleted"); showTab("browse");
    }

    // ==== CHATS ====
async function renderChats(c){
  if(!privateChatUser){
    c.innerHTML="<h2>Chats</h2><p>Open a chat from a post.</p>";
    return;
  }
  const pinnedClass=pinnedChats.includes(privateChatUser)?"pinned":"";
  c.innerHTML=`<h2>Chat with ${privateChatUser} <button onclick="pinChat('${privateChatUser}')">📌</button></h2>
    <div id="chatBox" class="${pinnedClass}"></div>
    <input id="chatInput" placeholder="Message">
    <button onclick="sendMsg()">Send</button>`;
  loadMessages();
}

function openPrivateChat(user){ 
  privateChatUser=user; 
  notifications = notifications.filter(n=>n.from!==user);
  localStorage.setItem("notifications",JSON.stringify(notifications));
  updateNotifBadge();
  showTab("chats"); 
}

async function sendMsg(){
  const text=document.getElementById("chatInput").value;
  if(!text.trim()) return;
  socket.emit("message",{user:me.username,text,to:privateChatUser}); 
  document.getElementById("chatInput").value="";
  const box=document.getElementById("chatBox");
  if(box){
    box.innerHTML+=`<div class="msg"><b>${me.username}:</b> ${text}</div>`;
    box.scrollTop=box.scrollHeight;
  }
}   // ✅ this closes sendMsg()

async function loadMessages(){
  const res=await fetch(`/api/messages/${me.username}/${privateChatUser}`,{credentials:"include"});
  const msgs=await res.json(); 
  const box=document.getElementById("chatBox"); 
  box.innerHTML="";
  msgs.forEach(m=>{
    box.innerHTML+=`<div class="msg"><b>${m.from_user}:</b> ${m.text}</div>`;
  });
  box.scrollTop=box.scrollHeight;
}

function pinChat(user){
  if(pinnedChats.includes(user)){ 
    pinnedChats=pinnedChats.filter(u=>u!==user); 
  } else pinnedChats.push(user);
  localStorage.setItem("pinnedChats",JSON.stringify(pinnedChats));
  alert("Pinned chats updated!");
}


    // ==== NOTIFICATIONS ====
    function renderNotifications(c){
      c.innerHTML="<h2>Notifications</h2>";
      if(notifications.length===0){ 
        c.innerHTML+="<p>No new notifications.</p>"; 
        updateNotifBadge(); 
        return; 
      }
      notifications.forEach((n,i)=>{
        c.innerHTML+=`<div class="card"><b>${n.from}</b>: ${n.text}<br>
          <small>${new Date(n.time||Date.now()).toLocaleString()}</small><br>
          <button onclick="openPrivateChat('${n.from}')">Open Chat</button>
          <button onclick="clearNotification(${i})">Dismiss</button></div>`;
      });
      updateNotifBadge();
    }
    function clearNotification(i){
      notifications.splice(i,1);
      localStorage.setItem("notifications",JSON.stringify(notifications));
      renderNotifications(document.getElementById("content"));
    }

    // ==== REPORT ====
    function renderReport(c){
      c.innerHTML=`<h2>Report Scammer</h2>
      <div class="card">
        <input id="accused" placeholder="Scammer Username">
        <input id="reporterEmail" type="email" placeholder="Your Email">
        <textarea id="reason" placeholder="Reason"></textarea>
        <button class="action" onclick="sendReport()">Submit</button>
        <div id="reportMsg"></div>
      </div>`;
    }
    async function sendReport(){
      const accused=document.getElementById("accused").value;
      const reason=document.getElementById("reason").value;
      const reporter=document.getElementById("reporterEmail").value;
      const res=await fetch("/api/report",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accused,reason,reporter}),credentials:"include"});
      document.getElementById("reportMsg").innerText=res.ok?"✅ Report Sent":"❌ Failed";
    }

    // ==== PLANS ====
function renderPlans(c){
  c.innerHTML=`<h2>Choose a Plan</h2>
  <div class="grid">
    <div class="card">
      <h3>Free</h3>
      <p>Basic access to BloxWorks.</p>
      <p>✅ Browse & create posts</p>
      <p>✅ Basic chat</p>
      <p>❌ No premium features</p>
    </div>
    <div class="card">
      <h3>Plus</h3>
      <p>Get more features & visibility.</p>
      <div id="paypal-button-container-plus"></div>
    </div>
    <div class="card">
      <h3>Pro</h3>
      <p>Unlock everything and boost your hiring power.</p>
      <div id="paypal-button-container-pro"></div>
    </div>
  </div>`;

  // PLUS plan
  paypal.Buttons({
    style: {shape:'rect',color:'gold',layout:'vertical',label:'subscribe'},
    createSubscription: function(data, actions) {
      return actions.subscription.create({ plan_id: 'P-1RT56666FT4517249NCXPAQQ' });
    },
    onApprove: async function(data, actions) {
      alert("Thanks for subscribing to PLUS!");
      // Persist subscription in DB
      await fetch("/api/setSubscription", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body:JSON.stringify({
          plan:"plus",
          paypal_sub_id:data.subscriptionID,
          expires_at:null
        })
      });
    }
  }).render('#paypal-button-container-plus');

  // PRO plan
  paypal.Buttons({
    style: {shape:'rect',color:'gold',layout:'vertical',label:'subscribe'},
    createSubscription: function(data, actions) {
      return actions.subscription.create({ plan_id: 'P-2XW832253H215311DNCXPDAA' });
    },
    onApprove: async function(data, actions) {
      alert("Thanks for subscribing to PRO!");
      // Persist subscription in DB
      await fetch("/api/setSubscription", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body:JSON.stringify({
          plan:"pro",
          paypal_sub_id:data.subscriptionID,
          expires_at:null
        })
      });
    }
  }).render('#paypal-button-container-pro');
}

    // ==== SETTINGS ====
    function renderSettings(c){
      c.innerHTML=`<h2>Settings</h2>
        <button onclick="deleteAccount()">Delete My Account</button>`;
    }
    async function deleteAccount(){
      if(confirm("Are you sure you want to delete your account? This cannot be undone.")){
        await fetch("/api/deleteAccount",{method:"POST",credentials:"include"});
        alert("Account deleted."); logout();
      }
    }

    // ==== ADMIN ====
    async function renderAdmin(c){
      c.innerHTML="<h2>Admin Dashboard</h2>";
      const users=await (await fetch("/api/admin/users",{credentials:"include"})).json();
      const posts=await (await fetch("/api/admin/posts",{credentials:"include"})).json();
      c.innerHTML+=`<h3>Users</h3><div class="grid">`+users.map(u=>`
        <div class="card">
          <b>${u.username}</b> (${u.email}) ${u.banned?"[BANNED]":""}
          <br><button onclick="banUser('${u.username}')">🚫 Ban</button>
          <button onclick="deleteUser('${u.username}')">🗑 Delete</button>
        </div>`).join("")+"</div>";
      c.innerHTML+=`<h3>Posts</h3><div class="grid">`+posts.map(p=>`
        <div class="card">
          <b>${p.title}</b> by ${p.username}
          <br>${p.description}
          <br><button onclick="adminDeletePost(${p.id})">🗑 Delete</button>
          <button onclick="adminSuspendPost(${p.id})">⏸ Suspend</button>
        </div>`).join("")+"</div>";
    }
    async function adminDeletePost(id){await fetch("/api/deletePostAdmin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id}),credentials:"include"});alert("Deleted");showTab("admin");}
    async function adminSuspendPost(id){await fetch("/api/suspendPost",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id}),credentials:"include"});alert("Suspended");showTab("admin");}
    async function banUser(u){await fetch("/api/banUser",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u}),credentials:"include"});alert("Banned");showTab("admin");}
    async function deleteUser(u){await fetch("/api/deleteUser",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u}),credentials:"include"});alert("Deleted");showTab("admin");}

    // ==== AUTO LOGIN RESTORE ====
    async function checkAuth() {
      const res = await fetch("/api/loginStatus",{credentials:"include"});
      if(res.ok){ 
        me = await res.json(); 
        initSocket();
        socket.emit("join", me.username);
        showAuth(); 
      } else showAuth();
      updateNotifBadge();
    }
    checkAuth();
  </script>
</body>
</html>
