<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BloxWorks</title>
  <style>
    :root {
      --bg: #f4f4f4; --text: #222; --card: #fff; --primary: #007bff; --header:#fff; --header-text:#222;
    }
    body.dark {
      --bg:#1e1e1e; --text:#ddd; --card:#2b2b2b; --primary:#ff8800; --header:#2b2b2b; --header-text:#fff;
    }
    body { margin:0; font-family:Arial,sans-serif; background:var(--bg); color:var(--text);}
    header { background:var(--header); color:var(--header-text); padding:10px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ccc;}
    .logo{font-size:22px;font-weight:bold;}
    nav{display:flex;justify-content:center;margin:10px;flex-wrap:wrap;}
    nav button{margin:5px;padding:8px 14px;border:none;cursor:pointer;border-radius:5px;background:var(--primary);color:white;position:relative;}
    #notifBadge{position:absolute;top:2px;right:2px;background:red;color:white;font-size:12px;padding:2px 6px;border-radius:50%;display:none;}
    #content{padding:20px;max-width:1000px;margin:auto;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px;}
    .card{background:var(--card);padding:15px;border-radius:6px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    input,textarea,select{width:100%;padding:8px;margin:5px 0;border-radius:4px;border:1px solid #ccc;background:var(--card);color:var(--text);}
    button.action{background:var(--primary);color:white;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;}
    #chatBox{border:1px solid #ccc;height:250px;overflow-y:scroll;padding:10px;background:var(--card);}
    .msg{margin:5px 0;}
    .hidden{display:none;}
    .pinned{border:2px solid gold;}
  </style>
</head>
<body>
  <header>
    <div class="logo">üß± BloxWorks</div>
    <div id="auth"></div>
    <button onclick="toggleTheme()">üåì</button>
  </header>

  <nav id="nav" class="hidden">
    <button onclick="showTab('browse')">Browse</button>
    <button onclick="showTab('create')">Create Post</button>
    <button onclick="showTab('myposts')">My Posts</button>
    <button onclick="showTab('chats')">Chats</button>
    <button onclick="showTab('notifications')">Notifications <span id="notifBadge">0</span></button>
    <button onclick="showTab('report')">Report</button>
    <button onclick="showTab('settings')">Settings</button>
    <button id="adminBtn" class="hidden" onclick="showTab('admin')">Admin Dashboard</button>
    <button onclick="logout()">Logout</button>
  </nav>

  <div id="content"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let me=null; 
    let socket=null; 
    let privateChatUser=null;
    let pinnedChats = JSON.parse(localStorage.getItem("pinnedChats")||"[]");
    let notifications = JSON.parse(localStorage.getItem("notifications")||"[]");

    function toggleTheme(){document.body.classList.toggle("dark");}

    // ==== SOCKET INIT ====
    function initSocket(){
      if(socket) return;
      socket = io();

      // receive chat messages
      socket.on("message",msg=>{
        if((msg.to===privateChatUser&&msg.user===me.username)||(msg.user===privateChatUser&&msg.to===me.username)){
          const box=document.getElementById("chatBox");
          if(box){
            box.innerHTML+=`<div class="msg"><b>${msg.user}:</b> ${msg.text}</div>`;
            box.scrollTop=box.scrollHeight;
          }
        }
      });

      // receive notifications
      socket.on("notification",note=>{
        addNotification(note);
      });
    }

    // ==== NOTIFICATIONS HANDLING ====
    function addNotification(note){
      notifications.push(note);
      localStorage.setItem("notifications", JSON.stringify(notifications));
      updateNotifBadge();
      if(document.getElementById("content").dataset.tab==="notifications"){
        renderNotifications(document.getElementById("content"));
      }
    }

    function updateNotifBadge(){
      const badge=document.getElementById("notifBadge");
      if(notifications.length>0){
        badge.style.display="inline-block";
        badge.textContent=notifications.length;
      } else {
        badge.style.display="none";
      }
    }

    // ==== AUTH ====
    function showAuth(){
      const div=document.getElementById("auth");
      const nav=document.getElementById("nav");
      if(!me){
        nav.classList.add("hidden");
        div.innerHTML=`<input id="username" placeholder="Username">
        <input id="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <label><input type="checkbox" id="tosCheck"> I agree to Terms</label><br>
        <button onclick="signup()">Sign Up</button>
        <button onclick="login()">Login</button>`;
        document.getElementById("content").innerHTML="";
      } else {
        nav.classList.remove("hidden");
        if(me.is_admin) document.getElementById("adminBtn").classList.remove("hidden");
        else document.getElementById("adminBtn").classList.add("hidden");
        div.innerHTML=`üë§ ${me.username}`;
        showTab("browse");
      }
    }

    async function signup(){
      if(!document.getElementById("tosCheck").checked) return alert("You must agree to Terms");
      const username=document.getElementById("username").value.trim();
      const email=document.getElementById("email").value.trim();
      const password=document.getElementById("password").value.trim();
      if(!username||!email||!password) return alert("All fields required");
      const res=await fetch("/api/signup",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username,email,password}),
        credentials:"include"
      });
      if(res.ok){ 
        alert("Signup successful! A 6-digit code has been sent to your email.");
        renderVerify(email);
      } else { const e=await res.json(); alert(e.error); }
    }

    function renderVerify(email){
      document.getElementById("content").innerHTML=`
        <h2>Verify Email</h2>
        <input id="vcode" placeholder="Enter 6-digit code">
        <button onclick="verifyCode('${email}')">Verify</button>`;
    }

    async function verifyCode(email){
      const code=document.getElementById("vcode").value.trim();
      const res=await fetch("/api/verifyCode",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({email,code}),
        credentials:"include"
      });
      if(res.ok){ alert("Email verified! You can now log in."); showAuth(); }
      else { const e=await res.json(); alert(e.error); }
    }

    async function login(){
      const username=document.getElementById("username").value.trim();
      const password=document.getElementById("password").value.trim();
      if(!username||!password) return alert("Enter username & password");
      const res=await fetch("/api/login",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({username,password}),
        credentials:"include"
      });
      if(res.ok){ 
        me=await res.json(); 
        initSocket();
        socket.emit("join", me.username); 
        showAuth(); 
      } else { const e=await res.json(); alert(e.error); }
    }

    function logout(){ me=null; document.cookie="token=; Max-Age=0"; showAuth(); }

    // ==== NAV HANDLER ====
    function showTab(tab){
      const c=document.getElementById("content");
      c.dataset.tab=tab;
      if(tab==="browse") renderBrowse(c);
      if(tab==="create") renderCreate(c);
      if(tab==="myposts") renderMyPosts(c);
      if(tab==="chats") renderChats(c);
      if(tab==="notifications") renderNotifications(c);
      if(tab==="report") renderReport(c);
      if(tab==="settings") renderSettings(c);
      if(tab==="admin") renderAdmin(c);
    }

    // ==== BROWSE ====
    async function renderBrowse(c){
      c.innerHTML=`<h2>Browse Posts</h2>
      <select id="filter" onchange="loadPosts()"><option value="all">All</option><option value="hiring">Hiring</option><option value="for_hire">For Hire</option></select>
      <input id="userFilter" placeholder="Filter by username" oninput="loadPosts()">
      <div class="grid" id="postList"></div>`;
      loadPosts();
    }
    async function loadPosts(){
      const res=await fetch("/api/posts",{credentials:"include"});
      const posts=await res.json();
      const list=document.getElementById("postList"); list.innerHTML="";
      const filter=document.getElementById("filter")?.value||"all";
      const uf=document.getElementById("userFilter")?.value||"";
      if(!Array.isArray(posts)) { list.innerHTML="<p>Error loading posts.</p>"; return; }
      posts.filter(p=>(filter==="all"||p.mode===filter)&&(uf===""||p.username.includes(uf))).forEach(p=>{
        list.innerHTML+=`<div class="card">
          <h3>${p.title}</h3>
          <p>${p.description}</p>
          <p><b>Budget:</b> ${p.budget} | <b>Payment:</b> ${p.payment} | <b>Timeline:</b> ${p.timeline} | <b>Category:</b> ${p.category}</p>
          <i>${p.mode} by ${p.username}</i><br>
          <button onclick="openPrivateChat('${p.username}')">üí¨ Chat</button>
          ${me.is_admin?`<button onclick="adminDeletePost(${p.id})">üóë Delete</button><button onclick="adminSuspendPost(${p.id})">‚è∏ Suspend</button>`:""}
        </div>`;
      });
    }

    // ==== CREATE POST ====
    function renderCreate(c){
      c.innerHTML=`<h2>Create Post</h2>
      <div class="card">
        <select id="mode"><option value="hiring">Hiring</option><option value="for_hire">For Hire</option></select>
        <input id="title" placeholder="Title">
        <textarea id="desc" placeholder="Description"></textarea>
        <input id="budget" placeholder="Budget">
        <select id="payment"><option>Robux</option><option>PayPal</option><option>Crypto</option><option>Other</option></select>
        <input id="timeline" placeholder="Timeline (e.g. 2 weeks)">
        <input id="category" placeholder="Category">
        <button class="action" onclick="createPost()">Create</button>
      </div>`;
    }
    async function createPost(){
      const body={mode:document.getElementById("mode").value,title:document.getElementById("title").value,
        description:document.getElementById("desc").value,budget:document.getElementById("budget").value,
        payment:document.getElementById("payment").value,timeline:document.getElementById("timeline").value,
        category:document.getElementById("category").value};
      const res=await fetch("/api/posts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),credentials:"include"});
      if(res.ok){ alert("Post created!"); showTab("myposts"); } else { const e=await res.json(); alert(e.error); }
    }

    // ==== MY POSTS ====
    async function renderMyPosts(c){
      const res=await fetch("/api/posts",{credentials:"include"}); const posts=await res.json();
      const mine=Array.isArray(posts)?posts.find(p=>p.username===me.username):null;
      if(!mine){ c.innerHTML="<p>You have no post. Create one!</p>"; return; }
      c.innerHTML=`<h2>My Post</h2>
        <div class="card">
          <input id="mtitle" value="${mine.title}">
          <textarea id="mdesc">${mine.description}</textarea>
          <input id="mbudget" value="${mine.budget}">
          <input id="mpayment" value="${mine.payment}">
          <input id="mtimeline" value="${mine.timeline}">
          <input id="mcategory" value="${mine.category}">
          <button onclick="editPost(${mine.id})">Save</button>
          <button onclick="deletePost(${mine.id})">Delete</button>
        </div>`;
    }
    async function editPost(id){
      const body={id,title:document.getElementById("mtitle").value,
        description:document.getElementById("mdesc").value,
        budget:document.getElementById("mbudget").value,
        payment:document.getElementById("mpayment").value,
        timeline:document.getElementById("mtimeline").value,
        category:document.getElementById("mcategory").value};
      await fetch("/api/editPost",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),credentials:"include"});
      alert("Updated!"); showTab("myposts");
    }
    async function deletePost(id){
      await fetch("/api/deletePost",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id}),credentials:"include"});
